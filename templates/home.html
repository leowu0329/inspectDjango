{% extends 'base.html' %}
{% load crispy_forms_tags %}

{% block title %}
  首頁
{% endblock %}

{% block css_style %}
  <style>
    .welcome-container {
      max-width: 600px;
      margin: 100px auto;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
      background-color: white;
    }
    .btn-logout {
      width: 100%;
    }
    .auth-links {
      margin-top: 20px;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>檢驗總表</h1>
      <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addCaseModal"><i class="fas fa-plus"></i> 新增筆數</button>
    </div>
    <div class="card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table table-striped table-bordered table-hover">
            <thead class="table-dark">
              <tr>
                <th>首件巡檢</th>
                <th>內/外銷</th>
                <th>客戶</th>
                <th>部門</th>
                <th>日期</th>
                <th>製令編號</th>
                <th>圖面版次</th>
                <th>品號</th>
                <th>品名</th>
                <th>數量</th>
                <th>巡檢員</th>
                <th>不良分類</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              {% for case in cases %}
                <tr>
                  <td>{{ case.inspection_type }}</td>
                  <td>{{ case.sale_type }}</td>
                  <td>{{ case.customer }}</td>
                  <td>{{ case.department }}</td>
                  <td>{{ case.date|date:'Y/m/d' }}</td>
                  <td>{{ case.work_order_number }}</td>
                  <td>{{ case.drawing_revision }}</td>
                  <td>{{ case.part_number }}</td>
                  <td>{{ case.part_name }}</td>
                  <td>{{ case.quantity }}</td>
                  <td>{{ case.inspector }}</td>
                  <td>{{ case.defect_category }}</td>
                  <td>
                    <a href="#" class="btn btn-primary btn-sm me-1"><i class="fas fa-edit"></i> 編輯</a>
                    <a href="#" class="btn btn-danger btn-sm"><i class="fas fa-trash-alt"></i> 刪除</a>
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="13" class="text-center">目前沒有任何案例</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Case Modal -->
  <div class="modal fade" id="addCaseModal" tabindex="-1" aria-labelledby="addCaseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="addCaseModalLabel">新增案例</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="addCaseForm" action="{% url 'create_case' %}" method="post">
            {% csrf_token %}
            {{ form|crispy }}
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">關閉</button>
          <button type="submit" form="addCaseForm" class="btn btn-primary">儲存</button>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script>
    // You can add any page-specific JavaScript here if needed
    document.addEventListener('DOMContentLoaded', function () {
      console.log('Home page loaded')
    })
    
    document.addEventListener('DOMContentLoaded', function () {
      const addCaseForm = document.getElementById('addCaseForm')
    
      addCaseForm.addEventListener('submit', function (e) {
        e.preventDefault()
    
        const formData = new FormData(addCaseForm)
    
        fetch(addCaseForm.action, {
          method: 'POST',
          body: formData,
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
          .then((response) => response.json())
          .then((data) => {
            if (data.status === 'success') {
              // 關閉 modal
              const modal = bootstrap.Modal.getInstance(document.getElementById('addCaseModal'))
              modal.hide()
    
              // 顯示 success alert
              Swal.fire({
                icon: 'success',
                title: '成功',
                text: data.message,
                timer: 1500,
                showConfirmButton: false
              }).then(() => {
                // 重新整理頁面以顯示新資料
                location.reload()
              })
            } else if (data.status === 'error') {
              // 清除舊的錯誤訊息
              document.querySelectorAll('.invalid-feedback').forEach((el) => el.remove())
              document.querySelectorAll('.is-invalid').forEach((el) => el.classList.remove('is-invalid'))
    
              // 顯示新的錯誤訊息
              for (const field in data.errors) {
                const input = document.getElementById(`id_${field}`)
                if (input) {
                  input.classList.add('is-invalid')
                  const errorDiv = document.createElement('div')
                  errorDiv.className = 'invalid-feedback'
                  errorDiv.innerText = data.errors[field]
                  input.parentNode.appendChild(errorDiv)
                }
              }
              Swal.fire({
                icon: 'error',
                title: '錯誤',
                text: '表單提交失敗，請檢查輸入的資料。'
              })
            }
          })
          .catch((error) => {
            console.error('Error:', error)
            Swal.fire({
              icon: 'error',
              title: '提交失敗',
              text: '發生未預期的錯誤，請稍後再試。'
            })
          })
      })
    })
  </script>
{% endblock %}
