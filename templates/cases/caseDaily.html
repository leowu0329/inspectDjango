{% extends 'base.html' %}

{% block title %}
  IPQC 異常日報
{% endblock %}

{% block content %}
  <div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
      <h1>日報(晨會資料)</h1>
      <div>
        <span class="ms-3 text-danger fw-bold">
          塑膠射出課-尺寸NG：{{ plastic_size_ng }}
        </span>
        <span class="ms-3 text-primary fw-bold">
          射出加工組-尺寸NG：{{ injection_size_ng }}
        </span>
      </div>
    </div>

    <div class="card mb-4">
      <div class="card-body">
        <form id="dateRangeForm" class="row g-3 align-items-end" autocomplete="off">
          <div class="col-md-5">
            <label for="startDate" class="form-label fw-bold">起始日期</label>
            <input type="date" class="form-control" id="startDate" name="startDate" value="{{ start_date }}" required />
          </div>
          <div class="col-md-5">
            <label for="endDate" class="form-label fw-bold">截止日期</label>
            <input type="date" class="form-control" id="endDate" name="endDate" value="{{ end_date }}" required />
          </div>
          <div class="col-md-2">
            <button type="submit" class="btn btn-primary">查詢</button>
          </div>
        </form>
      </div>
    </div>
    <div class="table-responsive">
      <table class="table table-bordered align-middle text-center" style="font-size: 0.95rem;">
        <thead class="table-light">
          <tr>
            <th colspan="2" rowspan="2">
              組別<br />IPQC
            </th>
            <th colspan="13">統計區間</th>
          </tr>
          <tr>
            <th colspan="13" id="ipqc-title">
              IPQC 異常回饋(統計區間：
              {% if start_date and end_date %}
                {{ start_date }} ~ {{ end_date }}
              {% else %}
                ~
              {% endif %}
              )
            </th>
          </tr>
          <tr>
            <th>部門別</th>
            <th>
              抽檢批數<br />合計{% if batch_total %}
                ({{ batch_total }})
              {% endif %}
            </th>
           

            {% for cat in defect_categories %}
              <th>{{ cat }}</th>
            {% endfor %}
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>塑膠射出課</td>
            <td><span class="count-highlight">{{ batch_counts.塑膠射出課 }}</span></td>
            <td><span class="count-highlight">{{ size_ng_counts.塑膠射出課 }}</span><br />({{ size_ng_percentages.塑膠射出課 }}%)</td>
            <td><span class="count-highlight">{{ appearance_ng_counts.塑膠射出課 }}</span><br />({{ appearance_ng_percentages.塑膠射出課 }}%)</td>
            <td><span class="count-highlight">{{ no_drawing_counts.塑膠射出課 }}</span><br />({{ no_drawing_percentages.塑膠射出課 }}%)</td>
            <td><span class="count-highlight">{{ drawing_mismatch_counts.塑膠射出課 }}</span><br />({{ drawing_mismatch_percentages.塑膠射出課 }}%)</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td><span class="count-highlight">{{ no_form_counts.塑膠射出課 }}</span><br />({{ no_form_percentages.塑膠射出課 }}%)</td>
            <td><span class="count-highlight">{{ routing_slip_abnormal_counts.塑膠射出課 }}</span><br />({{ routing_slip_abnormal_percentages.塑膠射出課 }}%)</td>
          </tr>
          <tr>
            <td>射出加工組</td>
            <td><span class="count-highlight">{{ batch_counts.射出加工組 }}</span></td>
            <td><span class="count-highlight">{{ size_ng_counts.射出加工組 }}</span><br />({{ size_ng_percentages.射出加工組 }}%)</td>
            <td><span class="count-highlight">{{ appearance_ng_counts.射出加工組 }}</span><br />({{ appearance_ng_percentages.射出加工組 }}%)</td>
            <td><span class="count-highlight">{{ no_drawing_counts.射出加工組 }}</span><br />({{ no_drawing_percentages.射出加工組 }}%)</td>
            <td><span class="count-highlight">{{ drawing_mismatch_counts.射出加工組 }}</span><br />({{ drawing_mismatch_percentages.射出加工組 }}%)</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td><span class="count-highlight">{{ no_form_counts.射出加工組 }}</span><br />({{ no_form_percentages.射出加工組 }}%)</td>
            <td><span class="count-highlight">{{ routing_slip_abnormal_counts.射出加工組 }}</span><br />({{ routing_slip_abnormal_percentages.射出加工組 }}%)</td>
          </tr>
          <tr>
            <td>機械加工課</td>
            <td><span class="count-highlight">{{ batch_counts.機械加工課 }}</span></td>
            <td><span class="count-highlight">{{ size_ng_counts.機械加工課 }}</span><br />({{ size_ng_percentages.機械加工課 }}%)</td>
            <td><span class="count-highlight">{{ appearance_ng_counts.機械加工課 }}</span><br />({{ appearance_ng_percentages.機械加工課 }}%)</td>
            <td><span class="count-highlight">{{ no_drawing_counts.機械加工課 }}</span><br />({{ no_drawing_percentages.機械加工課 }}%)</td>
            <td><span class="count-highlight">{{ drawing_mismatch_counts.機械加工課 }}</span><br />({{ drawing_mismatch_percentages.機械加工課 }}%)</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td><span class="count-highlight">{{ no_form_counts.機械加工課 }}</span><br />({{ no_form_percentages.機械加工課 }}%)</td>
            <td><span class="count-highlight">{{ routing_slip_abnormal_counts.機械加工課 }}</span><br />({{ routing_slip_abnormal_percentages.機械加工課 }}%)</td>
          </tr>
          <tr>
            <td>繞線區</td>
            <td><span class="count-highlight">{{ batch_counts.繞線區 }}</span></td>
            <td><span class="count-highlight">{{ size_ng_counts.繞線區 }}</span><br />({{ size_ng_percentages.繞線區 }}%)</td>
            <td><span class="count-highlight">{{ appearance_ng_counts.繞線區 }}</span><br />({{ appearance_ng_percentages.繞線區 }}%)</td>
            <td></td>
            <td><span class="count-highlight">{{ drawing_mismatch_counts.繞線區 }}</span><br />({{ drawing_mismatch_percentages.繞線區 }}%)</td>
            <td><span class="count-highlight">{{ resistance_abnormal_count }}</span><br />({{ resistance_abnormal_percentage }}%)</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
          </tr>
          <tr>
            <td>泵浦組裝組</td>
            <td><span class="count-highlight">{{ batch_counts.泵浦組裝組 }}</span></td>
            <td></td>
            <td><span class="count-highlight">{{ appearance_ng_counts.泵浦組裝組 }}</span><br />({{ appearance_ng_percentages.泵浦組裝組 }}%)</td>
            <td></td>
            <td></td>
            <td></td>
            <td><span class="count-highlight">{{ pump_characteristic_abnormal_count }}</span><br />({{ pump_characteristic_abnormal_percentage }}%)</td>
            <td><span class="count-highlight">{{ torque_abnormal_counts.泵浦組裝組 }}</span><br />({{ torque_abnormal_percentages.泵浦組裝組 }}%)</td>
            <td><span class="count-highlight">{{ sop_abnormal_counts.泵浦組裝組 }}</span><br />({{ sop_abnormal_percentages.泵浦組裝組 }}%)</td>
            <td></td>
            <td><span class="count-highlight">{{ no_form_counts.泵浦組裝組 }}</span><br />({{ no_form_percentages.泵浦組裝組 }}%)</td>
            <td><span class="count-highlight">{{ routing_slip_abnormal_counts.泵浦組裝組 }}</span><br />({{ routing_slip_abnormal_percentages.泵浦組裝組 }}%)</td>
          </tr>
          <tr>
            <td>電機組立課</td>
            <td><span class="count-highlight">{{ batch_counts.電機組立課 }}</span></td>
            <td></td>
            <td><span class="count-highlight">{{ appearance_ng_counts.電機組立課 }}</span><br />({{ appearance_ng_percentages.電機組立課 }}%)</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td><span class="count-highlight">{{ torque_abnormal_counts.電機組立課 }}</span><br />({{ torque_abnormal_percentages.電機組立課 }}%)</td>
            <td><span class="count-highlight">{{ sop_abnormal_counts.電機組立課 }}</span><br />({{ sop_abnormal_percentages.電機組立課 }}%)</td>
            <td><span class="count-highlight">{{ electrical_untestable_count }}</span><br />({{ electrical_untestable_percentage }}%)</td>
            <td><span class="count-highlight">{{ no_form_counts.電機組立課 }}</span><br />({{ no_form_percentages.電機組立課 }}%)</td>
            <td><span class="count-highlight">{{ routing_slip_abnormal_counts.電機組立課 }}</span><br />({{ routing_slip_abnormal_percentages.電機組立課 }}%)</td>
          </tr>
          <tr>
            <td>燒崁組立課</td>
            <td><span class="count-highlight">{{ batch_counts.燒崁組立課 }}</span></td>
            <td></td>
            <td><span class="count-highlight">{{ appearance_ng_counts.燒崁組立課 }}</span><br />({{ appearance_ng_percentages.燒崁組立課 }}%)</td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td></td>
            <td><span class="count-highlight">{{ sop_abnormal_counts.燒崁組立課 }}</span><br />({{ sop_abnormal_percentages.燒崁組立課 }}%)</td>
            <td></td>
            <td><span class="count-highlight">{{ no_form_counts.燒崁組立課 }}</span><br />({{ no_form_percentages.燒崁組立課 }}%)</td>
            <td><span class="count-highlight">{{ routing_slip_abnormal_counts.燒崁組立課 }}</span><br />({{ routing_slip_abnormal_percentages.燒崁組立課 }}%)</td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
{% endblock %}

{% block extra_js %}
  <script>
    function pad(n) {
      return n < 10 ? '0' + n : n
    }
    
    function getToday() {
      const d = new Date()
      return d.getFullYear() + '-' + pad(d.getMonth() + 1) + '-' + pad(d.getDate())
    }
    
    function getMonthFirst() {
      const d = new Date()
      return d.getFullYear() + '-' + pad(d.getMonth() + 1) + '-01'
    }
    
    document.addEventListener('DOMContentLoaded', function () {
      const startDate = document.getElementById('startDate')
      const endDate = document.getElementById('endDate')
      const form = document.getElementById('dateRangeForm')
      const ipqcTitle = document.getElementById('ipqc-title')
      
      // 設置預設日期
      if (!startDate.value) startDate.value = getMonthFirst()
      if (!endDate.value) endDate.value = getToday()
      
      // 日期驗證
      function validateDates() {
        if (startDate.value && endDate.value && endDate.value < startDate.value) {
          endDate.setCustomValidity('截止日期不可小於起始日期')
          endDate.reportValidity()
          return false
        } else {
          endDate.setCustomValidity('')
          return true
        }
      }
      
      // 標題即時更新
      function updateTitle() {
        if (startDate.value && endDate.value) {
          ipqcTitle.innerHTML = `IPQC 異常回饋(統計區間：${startDate.value} ~ ${endDate.value})`;
        } else {
          ipqcTitle.innerHTML = 'IPQC 異常回饋(統計區間：~)';
        }
      }
      
      // 表單提交處理
      form.addEventListener('submit', function(e) {
        e.preventDefault()
        if (validateDates()) {
          const params = new URLSearchParams()
          params.set('start_date', startDate.value)
          params.set('end_date', endDate.value)
          window.location.search = params.toString()
        }
      })
      
      // 日期變更時驗證
      startDate.addEventListener('change', validateDates)
      endDate.addEventListener('change', validateDates)
      
      // 頁面載入時也更新一次標題
      updateTitle();
    })
  </script>
{% endblock %}

<style>
  .count-highlight {
    font-size: 1.25em;
    font-weight: bold;
  }
</style>
